
<div class="uk-button uk-button-primary uk-button-small uk-modal-close" type="button" uk-toggle="target: #imaging-modal"><i class="fa fa-plus"></i>New image</div>

<div id="imaging-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
         <a class="uk-modal-close-default" type="button" uk-close></a>

        <form id="newImagingForm" class="uk-form uk-form-horizontal" method="POST" action="/characterisation/imaging" enctype='multipart/form-data'>

        <h3>Create new image</h3>


        <div class='uk-padding-small uk-width-1-1 uk-text-center uk-alert-success' id='existingSample' uk-alert></div>


        <% include ../samplePicker.ejs %>



        <label>Type</label>
        <select class="uk-select" name="type" id="type">
          <option value='' disabled selected>Select an image type..</option>
          <option value='Optical'>Optical</option>
          <option value='SEM'>SEM</option>
          <option value='TEM'>TEM</option>
        </select>

        <label>Machine</label>
        <input class="uk-input" name="machine" id="machine" type="text" />



        <label>Magnification (X) <span>OPTIONAL</span></label>
        <input class="uk-input" name="mag" id="mag" type="number" min=0 uk-tooltip="title:Only use this if all the images to be uploaded are taken at the same magnification" />

        <label>Notes</label>
        <textarea class="uk-textarea" name="notes" id="notes" rows=4 uk-tooltip="title:Notes are applied to all the images uploaded in this form"></textarea>


        <label>File(s)</label>
        <div class="uk-width-1-1">
            <div uk-form-custom>
                <input class="uk-file" type="file" id="file" name="upload" placeholder="Upload file(s)" oninput="previewFiles($(this))" accept="image/*" multiple required/>
                <button class="uk-button uk-button-default" type="button" tabindex="-1">Select</button>
                <div class="uk-width-1-1 uk-flex uk-flex-wrap uk-flex-middle" id="preview"></div>
            </div>

            <progress class='uk-progress' id='upload-progress' style="display:none"></progress>

        </div>


        <div class="uk-flex uk-flex-right">
           <div class="uk-button uk-button-default" onclick="$('#newImagingForm')[0].reset()"><i class="fa fa-refresh"></i>Reset form</div>
           <div class="uk-button uk-button-primary" onclick="uploadImage($('#newImagingForm'))"><i class="fa fa-upload"></i> Upload</div>
        </div>

        </form>




        <script>

            UIkit.util.on('#imaging-modal','beforeshow', function(){
                console.log('Added sample to this form')
                var existingSample = window.localStorage.getItem('currentCharSample')
                var existingPowder = window.localStorage.getItem('currentCharPowder')
                if(existingSample){
                    d3.select('#existingSample')
                        .html('Existing solid sample found for characterisation. Added to Sample Select.')
                    getSamples('Sample', existingSample)
                    $('#sample_type').val("Sample")
                    d3.selectAll('.samplePick').classed('uk-button-muted', true)
                    d3.selectAll('.samplePick').classed('uk-button-primary', false)

                }
                if(existingPowder){
                    d3.select('#existingSample')
                        .html('Existing powder sample found for characterisation. Added to Sample Select.')
                    getSamples('PowderSample', existingPowder)
                    $('#sample_type').val("PowderSample")
                    d3.selectAll('.samplePick').classed('uk-button-muted', true)
                    d3.selectAll('.samplePick').classed('uk-button-primary', false)

                }

            })




            function uploadImage(form){
                  var modal = document.getElementById('imaging-modal')
                  console.log("Uploading imaging form")
                  var sampleId = $('#sample').val()
                  if(!sampleId){
                      message({message: 'Please select a valid sample from the dropdown.' + err, status:"warning"})
                  }
                  else{

                  $('.uk-progress').show()
                  $('.uk-progress').width('0%')
                  $('.uk-progress').text('0%')
                  console.log(form[0])

                  var formData = new FormData(form[0])

                  var file = $('#file')[0].files
                  formData.append('upload', file)
                  console.log(file)
                  if(file){
                      form.find(':input').prop("disabled", true);
                        $.ajax({
                            url: '/characterisation/imaging',
                            type: "POST",
                            data: formData,
                            cache:false,
                            contentType: false,
                            processData: false,
                            xhr: function() {

                              $('progress').css('background','#ff4')
                              $('progress::-webkit-progress-value').css('background','#ff4')
                                  var myXhr = new XMLHttpRequest();
                                  myXhr.upload.addEventListener('progress',function(evt){
                                    if(evt.lengthComputable){
                                        var percentageComplete = evt.loaded / evt.total
                                        percentageComplete = parseInt(percentageComplete * 100)
                                        $('progress').text(percentageComplete + '%')
                                        $('progress').width(percentageComplete + "%")

                                    if(percentageComplete === 100){
                                        $('.uk-progress').width("100%")
                                        //form[0].reset()

                                        UIkit.modal(modal).hide()

                                      }
                                    }
                                  }, false );

                                  return myXhr;
                            },
                            success: function(data) {
                                form.find(':input').prop("disabled", false);
                                    message(data)
                                    getImaging()

                                },
                            error: function(data){
                              form.find(':input').prop("disabled", false);
                                    message(data)
                            }

                        });

                  }
                  else{
                    message({message:'Please pick at least one file to upload',status:'warning'})
                  }

            }


        }









        </script>






    </div>
</div>
